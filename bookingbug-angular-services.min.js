"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function __range__(left,right,inclusive){for(var range=[],ascending=left<right,end=inclusive?ascending?right+1:right-1:right,i=left;ascending?i<end:i>end;ascending?i++:i--)range.push(i);return range}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}angular.module("BBAdminServices",["BB","BBAdmin.Services","BBAdmin.Filters","BBAdmin.Controllers","trNgGrid","ui.calendar"]),angular.module("BBAdminServicesMockE2E",["BBAdminServices","BBAdminMockE2E"]),angular.module("BBAdminServices").config(function($logProvider){"ngInject";$logProvider.debugEnabled(!0)}),window.Collection.Clinic=function(_window$Collection$Ba){function Clinic(){return _classCallCheck(this,Clinic),_possibleConstructorReturn(this,_window$Collection$Ba.apply(this,arguments))}return _inherits(Clinic,_window$Collection$Ba),Clinic.prototype.checkItem=function(item){var _window$Collection$Ba2;return(_window$Collection$Ba2=_window$Collection$Ba.prototype.checkItem).call.apply(_window$Collection$Ba2,[this].concat(Array.prototype.slice.call(arguments)))},Clinic.prototype.matchesParams=function(item){return(!this.params.start_time||(this.start_time||(this.start_time=moment(this.params.start_time)),!this.start_time.isAfter(item.start_time)))&&((!this.params.end_time||(this.end_time||(this.end_time=moment(this.params.end_time)),!this.end_time.isBefore(item.end_time)))&&((!this.params.start_date||(this.start_date||(this.start_date=moment(this.params.start_date)),!this.start_date.isAfter(item.start_date)))&&(!this.params.end_date||(this.end_date||(this.end_date=moment(this.params.end_date)),!this.end_date.isBefore(item.end_date)))))},Clinic}(window.Collection.Base),angular.module("BBAdmin.Services").provider("ClinicCollections",function(){return{$get:function(){return new window.BaseCollections}}}),angular.module("BBAdminServices").directive("personTable",function($log,ModalForm,BBModel){return{controller:function($scope){return $scope.fields=["id","name","mobile"],$scope.getPeople=function(){return BBModel.Admin.Person.$query({company:$scope.company}).then(function(people){return $scope.people=people})},$scope.newPerson=function(){return ModalForm.new({company:$scope.company,title:"New Person",new_rel:"new_person",post_rel:"people",success:function(person){return $scope.people.push(person)}})},$scope.delete=function(person){return person.$del("self").then(function(){return $scope.people=_.reject($scope.people,person)},function(err){return $log.error("Failed to delete person")})},$scope.edit=function(person){return ModalForm.edit({model:person,title:"Edit Person"})},$scope.schedule=function(person){return person.$get("schedule").then(function(schedule){return ModalForm.edit({model:schedule,title:"Edit Schedule"})})}},link:function(scope,element,attrs){return scope.company?scope.getPeople():BBModel.Admin.Company.$query(attrs).then(function(company){return scope.company=company,scope.getPeople()})},templateUrl:"person_table_main.html"}}),angular.module("BBAdminServices").directive("resourceTable",function(BBModel,$log,ModalForm){return{controller:function($scope){return $scope.fields=["id","name"],$scope.getResources=function(){var params={company:$scope.company};return BBModel.Admin.Resource.$query(params).then(function(resources){return $scope.resources=resources})},$scope.newResource=function(){return ModalForm.new({company:$scope.company,title:"New Resource",new_rel:"new_resource",post_rel:"resources",size:"lg",success:function(resource){return $scope.resources.push(resource)}})},$scope.delete=function(resource){return resource.$del("self").then(function(){return $scope.resources=_.reject($scope.resources,function(p){return p.id===id})},function(err){return $log.error("Failed to delete resource")})},$scope.edit=function(resource){return ModalForm.edit({model:resource,title:"Edit Resource"})},$scope.schedule=function(resource){return resource.$get("schedule").then(function(schedule){return ModalForm.edit({model:schedule,title:"Edit Schedule"})})}},link:function(scope,element,attrs){return scope.company?scope.getResources():BBModel.Admin.Company.$query(attrs).then(function(company){return scope.company=company,scope.getResources()})},templateUrl:"resource_table_main.html"}}),angular.module("BBAdminServices").directive("scheduleCalendar",function(uiCalendarConfig,ScheduleRules){return{controller:function($scope,$attrs){$scope.calendarName="scheduleCal",$scope.eventSources=[{events:function(start,end,timezone,callback){return callback($scope.getEvents())}}],$scope.getCalendarEvents=function(start,end){return uiCalendarConfig.calendars.scheduleCal.fullCalendar("clientEvents",function(e){return(start.isAfter(e.start)||start.isSame(e.start))&&(end.isBefore(e.end)||end.isSame(e.end))})};var options=$scope.setOptions;return options||(options={}),$scope.options={calendar:{schedulerLicenseKey:"0598149132-fcs-1443104297",height:options.height||"auto",editable:!1,selectable:!0,defaultView:"agendaWeek",header:{left:"today,prev,next",center:"title",right:"month,agendaWeek"},selectHelper:!1,eventOverlap:!1,lazyFetching:!1,views:{agendaWeek:{duration:{weeks:1},allDaySlot:!1,slotEventOverlap:!1,minTime:options.min_time||"00:00:00",maxTime:options.max_time||"24:00:00"}},select:function(start,end,jsEvent,view){return $scope.getCalendarEvents(start,end).length>0?$scope.removeRange(start,end):$scope.addRange(start,end)},eventResizeStop:function(event,jsEvent,ui,view){return $scope.addRange(event.start,event.end)},eventDrop:function(event,delta,revertFunc,jsEvent,ui,view){if(event.start.hasTime()){var orig={start:moment(event.start).subtract(delta),end:moment(event.end).subtract(delta)};return $scope.removeRange(orig.start,orig.end),$scope.addRange(event.start,event.end)}},eventClick:function(event,jsEvent,view){return $scope.removeRange(event.start,event.end)}}},$scope.render=function(){return uiCalendarConfig.calendars.scheduleCal.fullCalendar("render")}},link:function(scope,element,attrs,ngModel){var scheduleRules=function(){return new ScheduleRules(ngModel.$viewValue)};return scope.getEvents=function(){return scheduleRules().toEvents()},scope.addRange=function(start,end){return ngModel.$setViewValue(scheduleRules().addRange(start,end)),ngModel.$render()},scope.removeRange=function(start,end){return ngModel.$setViewValue(scheduleRules().removeRange(start,end)),ngModel.$render()},scope.toggleRange=function(start,end){return ngModel.$setViewValue(scheduleRules().toggleRange(start,end)),ngModel.$render()},ngModel.$render=function(){if(uiCalendarConfig&&uiCalendarConfig.calendars.scheduleCal)return uiCalendarConfig.calendars.scheduleCal.fullCalendar("refetchEvents"),uiCalendarConfig.calendars.scheduleCal.fullCalendar("unselect")}},templateUrl:"schedule_cal_main.html",require:"ngModel",scope:{render:"=?",setOptions:"=options"}}}),angular.module("BBAdminServices").directive("scheduleEdit",function(){return{link:function(scope,element,attrs,ngModel){return ngModel.$render=function(){return scope.$$value$$=ngModel.$viewValue},scope.$watch("$$value$$",function(value){if(null!=value)return ngModel.$setViewValue(value)})},templateUrl:"schedule_edit_main.html",require:"ngModel",scope:{options:"="}}}),angular.module("schemaForm").config(function(schemaFormProvider,schemaFormDecoratorsProvider,sfPathProvider){return schemaFormDecoratorsProvider.addMapping("bootstrapDecorator","schedule","schedule_edit_form.html"),schemaFormDecoratorsProvider.createDirective("schedule","schedule_edit_form.html")}),angular.module("BBAdminServices").directive("scheduleTable",function(BBModel,$log,ModalForm){return{controller:function($scope){return $scope.fields=["id","name","mobile"],$scope.getSchedules=function(){var params={company:$scope.company};return BBModel.Admin.Schedule.query(params).then(function(schedules){return $scope.schedules=schedules})},$scope.newSchedule=function(){return ModalForm.new({company:$scope.company,title:"New Schedule",new_rel:"new_schedule",post_rel:"schedules",size:"lg",success:function(schedule){return $scope.schedules.push(schedule)}})},$scope.delete=function(schedule){return schedule.$del("self").then(function(){return $scope.schedules=_.reject($scope.schedules,schedule)},function(err){return $log.error("Failed to delete schedule")})},$scope.edit=function(schedule){return ModalForm.edit({model:schedule,title:"Edit Schedule",size:"lg"})}},link:function(scope,element,attrs){return scope.company?scope.getSchedules():BBModel.Admin.Company.query(attrs).then(function(company){return scope.company=company,scope.getSchedules()})},templateUrl:"schedule_table_main.html"}}),angular.module("BBAdminServices").directive("scheduleWeekdays",function(uiCalendarConfig,ScheduleRules){return{controller:function($scope,$attrs){$scope.calendarName="scheduleWeekdays",$scope.eventSources=[{events:function(start,end,timezone,callback){return callback($scope.getEvents())}}],$scope.getCalendarEvents=function(start,end){return uiCalendarConfig.calendars.scheduleWeekdays.fullCalendar("clientEvents",function(e){return(start.isAfter(e.start)||start.isSame(e.start))&&(end.isBefore(e.end)||end.isSame(e.end))})};var options=$scope.setOptions;return options||(options={}),$scope.options={calendar:{schedulerLicenseKey:"0598149132-fcs-1443104297",height:options.height||"auto",editable:!1,selectable:!0,defaultView:"agendaWeek",header:{left:"",center:"title",right:""},selectHelper:!1,eventOverlap:!1,views:{agendaWeek:{duration:{weeks:1},titleFormat:"[]",allDaySlot:!1,columnFormat:"ddd",slotEventOverlap:!1,minTime:options.min_time||"00:00:00",maxTime:options.max_time||"24:00:00"}},select:function(start,end,jsEvent,view){return $scope.getCalendarEvents(start,end).length>0?$scope.removeRange(start,end):$scope.addRange(start,end)},eventResizeStop:function(event,jsEvent,ui,view){return $scope.addRange(event.start,event.end)},eventDrop:function(event,delta,revertFunc,jsEvent,ui,view){if(event.start.hasTime()){var orig={start:moment(event.start).subtract(delta),end:moment(event.end).subtract(delta)};return $scope.removeRange(orig.start,orig.end),$scope.addRange(event.start,event.end)}},eventClick:function(event,jsEvent,view){return $scope.removeRange(event.start,event.end)}}},$scope.render=function(){return uiCalendarConfig.calendars.scheduleWeekdays.fullCalendar("render")}},link:function(scope,element,attrs,ngModel){var scheduleRules=function(){return new ScheduleRules(ngModel.$viewValue)};return scope.getEvents=function(){return scheduleRules().toWeekdayEvents()},scope.addRange=function(start,end){return ngModel.$setViewValue(scheduleRules().addWeekdayRange(start,end)),ngModel.$render()},scope.removeRange=function(start,end){return ngModel.$setViewValue(scheduleRules().removeWeekdayRange(start,end)),ngModel.$render()},ngModel.$render=function(){if(uiCalendarConfig&&uiCalendarConfig.calendars.scheduleWeekdays)return uiCalendarConfig.calendars.scheduleWeekdays.fullCalendar("refetchEvents"),uiCalendarConfig.calendars.scheduleWeekdays.fullCalendar("unselect")}},templateUrl:"schedule_cal_main.html",require:"ngModel",scope:{render:"=?",setOptions:"=options"}}}),angular.module("BBAdminServices").directive("serviceTable",function($uibModal,$log,ModalForm,BBModel){return{controller:function($scope){return $scope.fields=["id","name"],$scope.getServices=function(){var params={company:$scope.company};return BBModel.Admin.Service.$query(params).then(function(services){return $scope.services=services})},$scope.newService=function(){return ModalForm.new({company:$scope.company,title:"New Service",new_rel:"new_service",post_rel:"services",success:function(service){return $scope.services.push(service)}})},$scope.delete=function(service){return service.$del("self").then(function(){return $scope.services=_.reject($scope.services,service)},function(err){return $log.error("Failed to delete service")})},$scope.edit=function(service){return ModalForm.edit({model:service,title:"Edit Service"})},$scope.newBooking=function(service){return ModalForm.book({model:service,company:$scope.company,title:"New Booking",success:function(booking){return $log.info("Created new booking ",booking)}})}},link:function(scope,element,attrs){return scope.company?scope.getServices():BBModel.Admin.Company.query(attrs).then(function(company){return scope.company=company,scope.getServices()})},templateUrl:"service_table_main.html"}}),angular.module("BB.Models").factory("AdminAddressModel",function($q,BBModel,BaseModel,AddressModel){return function(_AddressModel){function Admin_Address(){return _classCallCheck(this,Admin_Address),_possibleConstructorReturn(this,_AddressModel.apply(this,arguments))}return _inherits(Admin_Address,_AddressModel),Admin_Address.prototype.distanceFrom=function(address,options){return this.dists||(this.dists=[]),this.dists[address]||(this.dists[address]=Math.round(50*Math.random(),0)),this.dists[address]},Admin_Address}(AddressModel)}),angular.module("BB.Models").factory("AdminClinicModel",function($q,BBModel,BaseModel,ClinicModel){return function(_ClinicModel){function Admin_Clinic(data){_classCallCheck(this,Admin_Clinic);var _this=_possibleConstructorReturn(this,_ClinicModel.call(this,data));return _this.repeat_rule||(_this.repeat_rule={}),_this.repeat_rule.rules||(_this.repeat_rule.rules={}),_this}return _inherits(Admin_Clinic,_ClinicModel),Admin_Clinic.prototype.calcRepeatRule=function(){var vals={};vals.name=this.name,vals.start_time=this.start_time.format("HH:mm"),vals.end_time=this.end_time.format("HH:mm"),vals.address_id=this.address_id,vals.resource_ids=[];for(var id in this.resources)this.resources[id]&&vals.resource_ids.push(id);vals.person_ids=[];for(id in this.people)this.people[id]&&vals.person_ids.push(id);vals.service_ids=[];for(id in this.services)this.services[id]&&vals.service_ids.push(id);return this.repeat_rule.properties=vals,this.repeat_rule},Admin_Clinic.prototype.getPostData=function(){var data={};data.name=this.name,data.repeat_rule=this.repeat_rule,data.start_time=this.start_time,data.end_time=this.end_time,data.resource_ids=[],data.update_for_repeat=this.update_for_repeat;for(var id in this.resources)this.resources[id]&&data.resource_ids.push(id);data.person_ids=[];for(id in this.people)this.people[id]&&data.person_ids.push(id);data.service_ids=[];for(id in this.services)this.services[id]&&data.service_ids.push(id);return this.address&&(data.address_id=this.address.id),this.settings&&(data.settings=this.settings),this.repeat_rule&&this.repeat_rule.rules&&this.repeat_rule.rules.frequency&&(data.repeat_rule=this.calcRepeatRule()),data},Admin_Clinic.prototype.save=function(){var _this2=this;return this.person_ids=_.compact(_.map(this.people,function(present,person_id){if(present)return person_id})),this.resource_ids=_.compact(_.map(this.resources,function(present,resource_id){if(present)return resource_id})),this.service_ids=_.compact(_.map(this.services,function(present,service_id){if(present)return service_id})),this.$put("self",{},this).then(function(clinic){return _this2.updateModel(clinic),_this2.setTimes(),_this2.setResourcesAndPeople()})},Admin_Clinic.prototype.$update=function(data){var _this3=this;return data||(data=this),this.$put("self",{},data).then(function(res){return _this3.constructor(res)})},Admin_Clinic}(ClinicModel)}),angular.module("BB.Models").factory("AdminPersonModel",function($q,AdminPersonService,BBModel,BaseModel,PersonModel){return function(_PersonModel){function Admin_Person(data){return _classCallCheck(this,Admin_Person),_possibleConstructorReturn(this,_PersonModel.call(this,data))}return _inherits(Admin_Person,_PersonModel),Admin_Person.prototype.setAttendance=function(status,duration){var _this2=this,defer=$q.defer();return this.$put("attendance",{},{status:status,estimated_duration:duration}).then(function(p){return _this2.updateModel(p),defer.resolve(_this2)},function(err){return defer.reject(err)}),defer.promise},Admin_Person.prototype.finishServing=function(){var _this3=this,defer=$q.defer();return this.$has("finish_serving")?(this.$flush("self"),this.$post("finish_serving").then(function(q){return _this3.$get("self").then(function(p){return _this3.updateModel(p)}),_this3.serving=null,defer.resolve(q)},function(err){return defer.reject(err)})):defer.reject("finish_serving link not available"),defer.promise},Admin_Person.prototype.isAvailable=function(start,end){var _this4=this,str=start.format("YYYY-MM-DD")+"-"+end.format("YYYY-MM-DD");return this.availability||(this.availability={}),this.availability[str]?"Yes"===this.availability[str]:(this.availability[str]="-",this.$has("schedule")?this.$get("schedule",{start_date:start.format("YYYY-MM-DD"),end_date:end.format("YYYY-MM-DD")}).then(function(sched){if(_this4.availability[str]="No",sched&&sched.dates&&sched.dates[start.format("YYYY-MM-DD")]&&"None"!==sched.dates[start.format("YYYY-MM-DD")])return _this4.availability[str]="Yes"}):this.availability[str]="Yes","Yes"===this.availability[str])},Admin_Person.prototype.startServing=function(queuer){var _this5=this,defer=$q.defer();if(this.$has("start_serving")){this.$flush("self");var params={queuer_id:queuer?queuer.id:null};this.$post("start_serving",params).then(function(q){return _this5.$get("self").then(function(p){return _this5.updateModel(p)}),_this5.serving=q,defer.resolve(q)},function(err){return defer.reject(err)})}else defer.reject("start_serving link not available");return defer.promise},Admin_Person.prototype.getQueuers=function(){var _this6=this,defer=$q.defer();return this.$has("queuers")?(this.$flush("queuers"),this.$get("queuers").then(function(collection){return collection.$get("queuers").then(function(queuers){var models=Array.from(queuers).map(function(q){return new BBModel.Admin.Queuer(q)});return _this6.queuers=models,defer.resolve(models)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)})):defer.reject("queuers link not available"),defer.promise},Admin_Person.prototype.getPostData=function(){var data={};return data.id=this.id,data.name=this.name,data.extra=this.extra,data.description=this.description,data},Admin_Person.prototype.$update=function(data){var _this7=this;return data||(data=this.getPostData()),this.$put("self",{},data).then(function(res){return _this7.constructor(res)})},Admin_Person.$query=function(params){return AdminPersonService.query(params)},Admin_Person.$block=function(company,person,data){return AdminPersonService.block(company,person,data)},Admin_Person.$signup=function(user,data){return AdminPersonService.signup(user,data)},Admin_Person.prototype.$refetch=function(){var _this8=this,defer=$q.defer();return this.$flush("self"),this.$get("self").then(function(res){return _this8.constructor(res),defer.resolve(_this8)},function(err){return defer.reject(err)}),defer.promise},Admin_Person}(PersonModel)}),angular.module("BB.Models").factory("AdminResourceModel",function($q,AdminResourceService,BBModel,BaseModel,ResourceModel){return function(_ResourceModel){function Admin_Resource(){return _classCallCheck(this,Admin_Resource),_possibleConstructorReturn(this,_ResourceModel.apply(this,arguments))}return _inherits(Admin_Resource,_ResourceModel),Admin_Resource.prototype.isAvailable=function(start,end){var _this2=this,str=start.format("YYYY-MM-DD")+"-"+end.format("YYYY-MM-DD");return this.availability||(this.availability={}),this.availability[str]?"Yes"===this.availability[str]:(this.availability[str]="-",this.$has("schedule")?this.$get("schedule",{start_date:start.format("YYYY-MM-DD"),end_date:end.format("YYYY-MM-DD")}).then(function(sched){if(_this2.availability[str]="No",sched&&sched.dates&&sched.dates[start.format("YYYY-MM-DD")]&&"None"!==sched.dates[start.format("YYYY-MM-DD")])return _this2.availability[str]="Yes"}):this.availability[str]="Yes","Yes"===this.availability[str])},Admin_Resource.$query=function(params){return AdminResourceService.query(params)},Admin_Resource.$block=function(company,resource,data){return AdminResourceService.block(company,resource,data)},Admin_Resource}(ResourceModel)}),angular.module("BB.Models").factory("AdminScheduleModel",function($q,AdminScheduleService,BBModel,BaseModel,ScheduleRules){return function(_BaseModel){function Admin_Schedule(data){return _classCallCheck(this,Admin_Schedule),_possibleConstructorReturn(this,_BaseModel.call(this,data))}return _inherits(Admin_Schedule,_BaseModel),Admin_Schedule.prototype.getPostData=function(){var data={};return data.id=this.id,data.rules=this.rules,data.name=this.name,data.company_id=this.company_id,data.duration=this.duration,data},Admin_Schedule.$query=function(params){return AdminScheduleService.query(params)},Admin_Schedule.$delete=function(schedule){return AdminScheduleService.delete(schedule)},Admin_Schedule.$update=function(schedule){return AdminScheduleService.update(schedule)},Admin_Schedule}(BaseModel)}),angular.module("BB.Models").factory("ScheduleRules",function(){return function(){function ScheduleRules(rules){_classCallCheck(this,ScheduleRules),this.addRangeToDate=this.addRangeToDate.bind(this),this.removeRangeFromDate=this.removeRangeFromDate.bind(this),null==rules&&(rules={}),this.rules=rules}return ScheduleRules.prototype.addRange=function(start,end){return this.applyFunctionToDateRange(start,end,"YYYY-MM-DD",this.addRangeToDate)},ScheduleRules.prototype.removeRange=function(start,end){return this.applyFunctionToDateRange(start,end,"YYYY-MM-DD",this.removeRangeFromDate)},ScheduleRules.prototype.addWeekdayRange=function(start,end){return this.applyFunctionToDateRange(start,end,"d",this.addRangeToDate)},ScheduleRules.prototype.removeWeekdayRange=function(start,end){return this.applyFunctionToDateRange(start,end,"d",this.removeRangeFromDate)},ScheduleRules.prototype.addRangeToDate=function(date,range){var ranges=this.rules[date]?this.rules[date]:[];return this.rules[date]=this.joinRanges(this.insertRange(ranges,range))},ScheduleRules.prototype.removeRangeFromDate=function(date,range){var ranges=this.rules[date]?this.rules[date]:[];if(this.rules[date]=this.joinRanges(this.subtractRange(ranges,range)),""===this.rules[date])return delete this.rules[date]},ScheduleRules.prototype.applyFunctionToDateRange=function(start,end,format,func){var _this=this,date=void 0,days=this.diffInDays(start,end);if(0===days){date=start.format(format);var range=[start.format("HHmm"),end.format("HHmm")].join("-");func(date,range)}else{var end_time=moment(start).endOf("day");this.applyFunctionToDateRange(start,end_time,format,func),_.each(__range__(1,days,!0),function(i){var start_time=void 0;return date=moment(start).add(i,"days"),i!==days?(start_time=moment(date).startOf("day"),end_time=moment(date).endOf("day"),_this.applyFunctionToDateRange(start_time,end_time,format,func)):0!==end.hour()||0!==end.minute()?(start_time=moment(end).startOf("day"),_this.applyFunctionToDateRange(start_time,end,format,func)):void 0})}return this.rules},ScheduleRules.prototype.diffInDays=function(start,end){return moment.duration(end.diff(start)).days()},ScheduleRules.prototype.insertRange=function(ranges,range){return ranges.splice(_.sortedIndex(ranges,range),0,range),ranges},ScheduleRules.prototype.subtractRange=function(ranges,range){return _.indexOf(ranges,range,!0)>-1?_.without(ranges,range):_.flatten(_.map(ranges,function(r){return range.slice(0,4)>=r.slice(0,4)&&range.slice(5,9)<=r.slice(5,9)?range.slice(0,4)===r.slice(0,4)?[range.slice(5,9),r.slice(5,9)].join("-"):range.slice(5,9)===r.slice(5,9)?[r.slice(0,4),range.slice(0,4)].join("-"):[[r.slice(0,4),range.slice(0,4)].join("-"),[range.slice(5,9),r.slice(5,9)].join("-")]:r}))},ScheduleRules.prototype.joinRanges=function(ranges){return _.reduce(ranges,function(m,range){return""===m?range:range.slice(0,4)<=m.slice(m.length-4,m.length)?range.slice(5,9)>=m.slice(m.length-4,m.length)?m.slice(0,m.length-4)+range.slice(5,9):m:[m,range].join()},"").split(",")},ScheduleRules.prototype.filterRulesByDates=function(){return _.pick(this.rules,function(value,key){return key.match(/^\d{4}-\d{2}-\d{2}$/)&&"None"!==value})},ScheduleRules.prototype.filterRulesByWeekdays=function(){return _.pick(this.rules,function(value,key){return key.match(/^\d$/)})},ScheduleRules.prototype.formatTime=function(time){return[time.slice(0,2),time.slice(2,4)].join(":")},ScheduleRules.prototype.toEvents=function(d){var _this2=this;return d&&"None"!==this.rules[d]?_.map(this.rules[d],function(range){return{start:[d,_this2.formatTime(range.split("-")[0])].join("T"),end:[d,_this2.formatTime(range.split("-")[1])].join("T")}}):_.reduce(this.filterRulesByDates(),function(memo,ranges,date){return memo.concat(_.map(ranges,function(range){return{start:[date,_this2.formatTime(range.split("-")[0])].join("T"),end:[date,_this2.formatTime(range.split("-")[1])].join("T")}}))},[])},ScheduleRules.prototype.toWeekdayEvents=function(){var _this3=this;return _.reduce(this.filterRulesByWeekdays(),function(memo,ranges,day){var date=moment().set("day",day).format("YYYY-MM-DD");return memo.concat(_.map(ranges,function(range){return{start:[date,_this3.formatTime(range.split("-")[0])].join("T"),end:[date,_this3.formatTime(range.split("-")[1])].join("T")}}))},[])},ScheduleRules}()}),angular.module("BB.Models").factory("AdminServiceModel",function($q,AdminServiceService,BBModel,ServiceModel){return function(_ServiceModel){function Admin_Service(){return _classCallCheck(this,Admin_Service),_possibleConstructorReturn(this,_ServiceModel.apply(this,arguments))}return _inherits(Admin_Service,_ServiceModel),Admin_Service.$query=function(params){return AdminServiceService.query(params)},Admin_Service}(ServiceModel)}),angular.module("BBAdmin.Services").factory("AdminAddressService",function($q,BBModel){return{query:function(params){var company=params.company,defer=$q.defer();return company.$get("addresses").then(function(collection){return collection.$get("addresses").then(function(addresss){var models=Array.from(addresss).map(function(s){return new BBModel.Admin.Address(s)});return defer.resolve(models)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}),defer.promise}}}),angular.module("BBAdmin.Services").factory("AdminClinicService",function($q,BBModel,ClinicCollections,$window){return{query:function(params){var company=params.company,defer=$q.defer();if(params.id)company.$get("clinics",params).then(function(clinic){return clinic=new BBModel.Admin.Clinic(clinic),
defer.resolve(clinic)},function(err){return defer.reject(err)});else{var existing=ClinicCollections.find(params);existing&&!params.skip_cache?defer.resolve(existing):(params.skip_cache&&(existing&&ClinicCollections.delete(existing),company.$flush("clinics",params)),company.$get("clinics",params).then(function(collection){return collection.$get("clinics").then(function(clinics){var models=Array.from(clinics).map(function(s){return new BBModel.Admin.Clinic(s)});return clinics=new $window.Collection.Clinic(collection,models,params),ClinicCollections.add(clinics),defer.resolve(clinics)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}))}return defer.promise},create:function(prms,clinic){var company=prms.company,deferred=$q.defer();return company.$post("clinics",{},clinic.getPostData()).then(function(clinic){return clinic=new BBModel.Admin.Clinic(clinic),ClinicCollections.checkItems(clinic),deferred.resolve(clinic)},function(err){return deferred.reject(err)}),deferred.promise},cancel:function(clinic){var deferred=$q.defer();return clinic.$post("cancel",clinic).then(function(clinic){return clinic=new BBModel.Admin.Clinic(clinic),ClinicCollections.deleteItems(clinic),deferred.resolve(clinic)},function(err){return deferred.reject(err)}),deferred.promise},update:function(clinic){var deferred=$q.defer();return clinic.$put("self",{},clinic.getPostData()).then(function(c){return clinic=new BBModel.Admin.Clinic(c),ClinicCollections.checkItems(clinic),deferred.resolve(clinic)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BBAdminServices").factory("AdminPersonService",function($q,$window,$rootScope,halClient,SlotCollections,BookingCollections,BBModel,LoginService,$log){return{query:function(params){var company=params.company,defer=$q.defer();return company.$has("people")?company.$get("people",params).then(function(collection){if(collection.$has("people"))return collection.$get("people").then(function(people){var models=Array.from(people).map(function(p){return new BBModel.Admin.Person(p)});return defer.resolve(models)},function(err){return defer.reject(err)});var obj=new BBModel.Admin.Person(collection);return defer.resolve(obj)},function(err){return defer.reject(err)}):($log.warn("company has no people link"),defer.reject("company has no people link")),defer.promise},block:function(company,person,data){var deferred=$q.defer();return person.$put("block",{},data).then(function(response){if(response.$href("self").indexOf("bookings")>-1){var booking=new BBModel.Admin.Booking(response);return BookingCollections.checkItems(booking),deferred.resolve(booking)}var slot=new BBModel.Admin.Slot(response);return SlotCollections.checkItems(slot),deferred.resolve(slot)},function(err){return deferred.reject(err)}),deferred.promise},signup:function(user,data){var defer=$q.defer();return user.$get("company").then(function(company){var params={};return company.$post("people",params,data).then(function(person){return person.$has("administrator")?person.$get("administrator").then(function(user){return LoginService.setLogin(user),defer.resolve(person)}):defer.resolve(person)},function(err){return defer.reject(err)}),defer.promise})}}}),angular.module("BBAdmin.Services").factory("AdminResourceService",function($q,UriTemplate,halClient,SlotCollections,BBModel,BookingCollections){return{query:function(params){var company=params.company,defer=$q.defer();return company.$get("resources",params).then(function(collection){return collection.$get("resources").then(function(resources){var models=Array.from(resources).map(function(r){return new BBModel.Admin.Resource(r)});return defer.resolve(models)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}),defer.promise},block:function(company,resource,data){var deferred=$q.defer();return resource.$put("block",{},data).then(function(response){if(response.$href("self").indexOf("bookings")>-1){var booking=new BBModel.Admin.Booking(response);return BookingCollections.checkItems(booking),deferred.resolve(booking)}var slot=new BBModel.Admin.Slot(response);return SlotCollections.checkItems(slot),deferred.resolve(slot)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BBAdmin.Services").factory("AdminScheduleService",function($q,BBModel,ScheduleRules,BBAssets){var schedule_cache={},cacheDates=function(asset,dates){return schedule_cache[asset.self]||(schedule_cache[asset.self]={}),function(){var result=[];for(var k in dates){var v=dates[k];result.push(schedule_cache[asset.self][k]=v)}return result}()},getCacheDates=function(asset,start,end){if(!schedule_cache[asset.self])return!1;for(var curr=moment(start),dates=[],asset_cache=schedule_cache[asset.self];curr.unix()<end.unix();){var test=curr.format("YYYY-MM-DD");if(!asset_cache[test])return!1;dates[test]=asset_cache[test],curr=curr.add(1,"day")}return dates},loadScheduleCaches=function(assets){var proms=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(assets)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var asset=_step.value;asset.$has("immediate_schedule")&&function(asset){var prom=asset.$get("immediate_schedule");proms.push(prom),prom.then(function(schedules){return cacheDates(asset,schedules.dates)})}(asset)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}var fin=$q.defer();return proms.length>0?$q.all(proms).then(function(){return fin.resolve()}):fin.resolve(),fin.promise};return{query:function(params){var company=params.company,defer=$q.defer();return company.$get("schedules").then(function(collection){return collection.$get("schedules").then(function(schedules){var models=Array.from(schedules).map(function(s){return new BBModel.Admin.Schedule(s)});return defer.resolve(models)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}),defer.promise},delete:function(schedule){var deferred=$q.defer();return schedule.$del("self").then(function(schedule){return schedule=new BBModel.Admin.Schedule(schedule),deferred.resolve(schedule)},function(err){return deferred.reject(err)}),deferred.promise},update:function(schedule){var deferred=$q.defer();return schedule.$put("self",{},schedule.getPostData()).then(function(c){return schedule=new BBModel.Admin.Schedule(c),deferred.resolve(schedule)},function(err){return deferred.reject(err)})},mapAssetsToScheduleEvents:function(start,end,assets){var assets_with_schedule=_.filter(assets,function(asset){return asset.$has("schedule")});return _.map(assets_with_schedule,function(asset){var events=void 0,rules=void 0,found=getCacheDates(asset,start,end);if(found){rules=new ScheduleRules(found),events=rules.toEvents(),_.each(events,function(e){return e.resourceId=parseInt(asset.id)+"_"+asset.type[0],e.title=asset.name,e.start=moment(e.start),e.end=moment(e.end),e.rendering="background"});var prom=$q.defer();return prom.resolve(events),prom.promise}var params={start_date:start.format("YYYY-MM-DD"),end_date:end.format("YYYY-MM-DD")};return asset.$get("schedule",params).then(function(schedules){return rules=new ScheduleRules(schedules.dates),events=rules.toEvents(),_.each(events,function(e){return e.resourceId=parseInt(asset.id)+"_"+asset.type[0],e.title=asset.name,e.start=moment(e.start),e.end=moment(e.end),e.rendering="background"}),events})})},getAssetsScheduleEvents:function(company,start,end,filtered,requested){var _this=this;if(null==filtered&&(filtered=!1),null==requested&&(requested=[]),filtered)return loadScheduleCaches(requested).then(function(){return $q.all(_this.mapAssetsToScheduleEvents(start,end,requested)).then(function(schedules){return _.flatten(schedules)})});var localMethod=this.mapAssetsToScheduleEvents;return BBAssets.getAssets(company).then(function(assets){return loadScheduleCaches(assets).then(function(){return $q.all(localMethod(start,end,assets)).then(function(schedules){return _.flatten(schedules)})})})}}}),angular.module("BBAdmin.Services").factory("AdminServiceService",function($q,BBModel,$log){return{query:function(params){var company=params.company,defer=$q.defer();return company.$get("services").then(function(collection){return collection.$get("services").then(function(services){var models=Array.from(services).map(function(s){return new BBModel.Admin.Service(s)});return defer.resolve(models)},function(err){return defer.reject(err)})},function(err){return defer.reject(err)}),defer.promise}}}),angular.module("BBAdminServices").factory("BB.Service.schedule",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Admin.Schedule(resource)}}}),angular.module("BBAdminServices").factory("BB.Service.person",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Admin.Person(resource)}}}),angular.module("BBAdminServices").factory("BB.Service.people",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred=$q.defer();return resource.$get("people").then(function(items){var models=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var i=_step.value;models.push(new BBModel.Admin.Person(i))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return deferred.resolve(models)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BBAdminServices").factory("BB.Service.resource",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Admin.Resource(resource)}}}),angular.module("BBAdminServices").factory("BB.Service.resources",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred=$q.defer();return resource.$get("resources").then(function(items){var models=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var i=_step2.value;models.push(new BBModel.Admin.Resource(i))}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return deferred.resolve(models)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BBAdminServices").factory("BB.Service.service",function($q,BBModel){return{unwrap:function(resource){return new BBModel.Admin.Service(resource)}}}),angular.module("BBAdminServices").factory("BB.Service.services",function($q,BBModel){return{promise:!0,unwrap:function(resource){var deferred=$q.defer();return resource.$get("services").then(function(items){var models=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=Array.from(items)[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var i=_step3.value;models.push(new BBModel.Admin.Service(i))}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return deferred.resolve(models)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BBAdminServices").config(function($translateProvider){"ngInject";var translations={SERVICES:{PERSON_TABLE:{NEW_PERSON:"New Person",DELETE:"@:COMMON.BTN.DELETE",EDIT:"@:COMMON.BTN.EDIT",SCHEDULE:"@:COMMON.TERMINOLOGY.SCHEDULE"},RESOURCE_TABLE:{NEW_RESOURCE:"New Resource",DELETE:"@:COMMON.BTN.DELETE",EDIT:"@:COMMON.BTN.EDIT",SCHEDULE:"@:COMMON.TERMINOLOGY.SCHEDULE"},SERVICE_TABLE:{NEW_SERVICE:"New Service",EDIT:"@:COMMON.BTN.EDIT",BOOK_BTN:"@:COMMON.BTN.BOOK"}}};$translateProvider.translations("en",translations)});